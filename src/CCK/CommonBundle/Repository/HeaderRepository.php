<?php

namespace CCK\CommonBundle\Repository;

use Doctrine\ORM\EntityRepository;

/**
 * HeaderRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class HeaderRepository extends EntityRepository
{
	public function getAllMidashi($ver = null){
		if($ver != '0'){
			$qb = $this->createQueryBuilder('c')
			->select('c.name')
			->addSelect('c.headerId')
			->addSelect('c.id')
			->addSelect('c.hen')
			->addSelect('c.sho')
			->addSelect('c.dai')
			->addSelect('c.chu')
			->addSelect('c.ko')
			->where('c.deleteFlag = :deleteFlag')
			->andWhere('c.versionId = :version_id')
			->addOrderBy('c.hen')
			->addOrderBy('c.sho')
			->addOrderBy('c.dai')
			->addOrderBy('c.chu')
			->addOrderBy('c.ko')
			->addOrderBy('c.sort')
			->setParameters(array(
					'deleteFlag' => false,
					'version_id' => $ver
			));
		}else{
			$qb = $this->createQueryBuilder('c')
			->select('c.name')
			->select('c.headerId')
			->addSelect('c.id')
			->addSelect('c.hen')
			->addSelect('c.sho')
			->addSelect('c.dai')
			->addSelect('c.chu')
			->addSelect('c.ko')
			->where('c.deleteFlag = :deleteFlag')
			->addOrderBy('c.hen')
			->addOrderBy('c.sho')
			->addOrderBy('c.dai')
			->addOrderBy('c.chu')
			->addOrderBy('c.ko')
			->addOrderBy('c.sort')
			->setParameters(array(
					'deleteFlag' => false
			));
		}

		return $qb->getQuery()->getResult();
	}

	public function getHenMidashi($ver = null){
		//if($ver != '0'){
			$qb = $this->createQueryBuilder('c')
			->select('c.name')
			->addSelect('c.hen id')
			->where('c.deleteFlag = :deleteFlag')
			->andWhere('c.versionId = :version_id')
			->andWhere('c.headerId = :header_id')
			->addOrderBy('c.hen')
			->setParameters(array(
					'deleteFlag' => false,
					'version_id' => $ver,
					'header_id' => '1'
			));
		/*}else{
			$qb = $this->createQueryBuilder('c')
			->select('c.name')
			->addSelect('c.hen id')
			->where('c.deleteFlag = :deleteFlag')
			->andWhere('c.headerId = :header_id')
			->addOrderBy('c.hen')
			->setParameters(array(
					'deleteFlag' => false,
					'header_id' => '1'
			));
		}*/

		return $qb->getQuery()->getResult();
	}

	public function getShoMidashi($ver, $hen = null){
		$qb = $this->createQueryBuilder('c')
		->select('c.name')
		->addSelect('c.sho id')
		->where('c.deleteFlag = :deleteFlag')
		->andWhere('c.versionId = :version_id')
		->andWhere('c.headerId = :header_id')
		->andWhere('c.hen = :hen')
		->addOrderBy('c.hen')
		->addOrderBy('c.sho')
		->setParameters(array(
				'deleteFlag' => false,
				'version_id' => $ver,
				'hen' => $hen,
				'header_id' => '2'
		));

		return $qb->getQuery()->getResult();
	}

	public function getDaiMidashi($ver, $hen, $sho = null){
		$qb = $this->createQueryBuilder('c')
		->select('c.name')
		->addSelect('c.dai id')
		->where('c.deleteFlag = :deleteFlag')
		->andWhere('c.versionId = :version_id')
		->andWhere('c.headerId = :header_id')
		->andWhere('c.hen = :hen')
		->andWhere('c.sho = :sho')
		->addOrderBy('c.hen')
		->addOrderBy('c.sho')
		->addOrderBy('c.dai')
		->setParameters(array(
				'deleteFlag' => false,
				'version_id' => $ver,
				'hen' => $hen,
				'sho' => $sho,
				'header_id' => '3'
		));

		return $qb->getQuery()->getResult();
	}

	public function getChuMidashi($ver, $hen, $sho, $dai = null){
		$qb = $this->createQueryBuilder('c')
		->select('c.name')
		->addSelect('c.chu id')
		->where('c.deleteFlag = :deleteFlag')
		->andWhere('c.versionId = :version_id')
		->andWhere('c.headerId = :header_id')
		->andWhere('c.hen = :hen')
		->andWhere('c.sho = :sho')
		->andWhere('c.dai = :dai')
		->addOrderBy('c.hen')
		->addOrderBy('c.sho')
		->addOrderBy('c.dai')
		->addOrderBy('c.chu')
		->setParameters(array(
				'deleteFlag' => false,
				'version_id' => $ver,
				'hen' => $hen,
				'sho' => $sho,
				'dai' => $dai,
				'header_id' => '4'
		));

		return $qb->getQuery()->getResult();
	}

	public function getKoMidashi($ver, $hen, $sho, $dai, $chu = null){
		$qb = $this->createQueryBuilder('c')
		->select('c.name')
		->addSelect('c.ko id')
		->where('c.deleteFlag = :deleteFlag')
		->andWhere('c.versionId = :version_id')
		->andWhere('c.headerId = :header_id')
		->andWhere('c.hen = :hen')
		->andWhere('c.sho = :sho')
		->andWhere('c.dai = :dai')
		->andWhere('c.chu = :chu')
		->addOrderBy('c.hen')
		->addOrderBy('c.sho')
		->addOrderBy('c.dai')
		->addOrderBy('c.chu')
		->addOrderBy('c.ko')
		->setParameters(array(
				'deleteFlag' => false,
				'version_id' => $ver,
				'hen' => $hen,
				'sho' => $sho,
				'dai' => $dai,
				'chu' => $chu,
				'header_id' => '5'
		));

		return $qb->getQuery()->getResult();
	}

	public function getNextHeaderId($version, $header_level, $header_field, $hen = null, $sho = null, $dai = null, $chu = null){
		$sql = "
			SELECT
				MAX(Header." . $header_field . ") max_id
			FROM
				Header
			WHERE
				Header.version_id = " . $version . "
				AND Header.header_id = " . $header_level;

		if($hen){
			$sql .= " AND Header.hen = ".$hen;
		}
		if($sho){
			$sql .= " AND Header.sho = ".$sho;
		}
		if($dai){
			$sql .= " AND Header.dai = ".$dai;
		}
		if($chu){
			$sql .= " AND Header.chu = ".$chu;
		}

		$sql .= "
				AND Header.delete_flag = FALSE
			GROUP BY Header.version_id,Header.header_id";

		$result = $this->getEntityManager()->getConnection()->executeQuery($sql)->fetchAll();

		return $result;
	}

	public function getSortUpdateHeader($version, $header_level, $hen, $sho, $dai, $chu, $ko){
		$sql = "
			SELECT
				*
			FROM
				Header
			WHERE
				Header.version_id = " . $version ;

		if($header_level > 0){
			$sql .= " AND Header.hen = ".$hen;
		}
		if($header_level > 1){
			$sql .= " AND Header.sho = ".$sho;
		}
		if($header_level > 2){
			$sql .= " AND Header.dai = ".$dai;
		}
		if($header_level > 3){
			$sql .= " AND Header.chu = ".$chu;
		}
		if($header_level > 4){
			$sql .= " AND Header.ko = ".$ko;
		}

		$sql .= "
				AND Header.delete_flag = FALSE";

		$result = $this->getEntityManager()->getConnection()->executeQuery($sql)->fetchAll();

		return $result;
	}

	public function updateHeaderId($version,$arrHeaderId,$filed,$idx){
		$sql = "UPDATE Header SET Header." . $filed . "=" . $idx . " ,Header.modify_date='". date("Y-m-d H:i:s") ."' WHERE Header.id IN (" . $arrHeaderId . ") AND Header.version_id = " . $version;
		$count = $this->getEntityManager()->getConnection()->executeUpdate($sql);
		return $count;
	}

}
